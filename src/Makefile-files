# -*- Makefile -*-

erlpkgbin_PROGRAMS =
erlpkginclude_HEADERS =
erlpkgebeam_DATA =


if HAVE_LIBUSB
EXTRA_DIST += src/test-libusb0.sh src/test-libusb0.cmds
TESTS += src/test-libusb0.sh
check_PROGRAMS += erlusb-libusb0

erlpkgbin_PROGRAMS += erlusb-libusb0
erlusb_libusb0_SOURCES  = src/erlusb-main.c
erlusb_libusb0_SOURCES += src/erlusb-ei.c src/erlusb-ei.h
erlusb_libusb0_SOURCES += src/erlusb-log.c src/erlusb-log.h
erlusb_libusb0_SOURCES += src/driver-libusb0.c src/driver.h
# libusb-0.1's usb.h does not work with --std=c99
# erlusb-log.c does not work with --std=c89 (requires va_copy)
# so gnu89 fits the bill
erlusb_libusb0_CPPFLAGS = $(AM_CPPFLAGS) $(ERL_INTERFACE_CPPFLAGS) --std=gnu89 $(LIBUSB_CFLAGS) $(CPPFLAGS)
erlusb_libusb0_LDADD = $(ERL_INTERFACE_LIBS) $(LIBUSB_LIBS)
erlusb_libusb0_LDFLAGS = -lpthread
endif


if HAVE_LIBUSB_10
EXTRA_DIST += src/test-libusb1.sh src/test-libusb1.cmds
TESTS += src/test-libusb1.sh
check_PROGRAMS += erlusb-libusb1

erlpkgbin_PROGRAMS += erlusb-libusb1
erlusb_libusb1_SOURCES  = src/erlusb-main.c
erlusb_libusb1_SOURCES += src/erlusb-ei.c src/erlusb-ei.h
erlusb_libusb1_SOURCES += src/erlusb-log.c src/erlusb-log.h
erlusb_libusb1_SOURCES += src/driver-libusb1.c src/driver.h
# libusb-1.0's usb.h works with neither --std=c90 nor --std=c99 :-(
# Using --std=c99 with locally patched libusb-1.0.
erlusb_libusb1_CPPFLAGS = $(AM_CPPFLAGS) $(ERL_INTERFACE_CPPFLAGS) --std=c99 $(LIBUSB_10_CFLAGS) $(CPPFLAGS)
erlusb_libusb1_LDADD = $(ERL_INTERFACE_LIBS) $(LIBUSB_10_LIBS)
erlusb_libusb1_LDFLAGS = -lpthread
endif


erlpkginclude_HEADERS += src/erlusb.hrl
erlpkgebeam_DATA += src/erlusb.beam
CLEANFILES += src/erlusb.beam erlusb.log erlusb.vlog
EXTRA_DIST += src/erlusb.erl src/erlusb.hrl

# This rule works as the automake subdir-objects option prescribes.
src/erlusb.beam: $(srcdir)/src/erlusb.erl $(srcdir)/src/erlusb.hrl
	mkdir -p src
	$(ERLC) $(AM_ERLCFLAGS) $(ERLCFLAGS) -o src $<


erlpkgebeam_DATA += src/garmin.beam
CLEANFILES += src/garmin.beam
EXTRA_DIST += src/garmin.erl
src/garmin.beam: $(srcdir)/src/garmin.erl $(srcdir)/src/erlusb.hrl
	mkdir -p src
	$(ERLC) $(AM_ERLCFLAGS) $(ERLCFLAGS) -o src $<
